# 쿠팡 가격 수집 워크플로우
# 매일 오전 7시(KST)에 실행 (UTC 22:00)
#
# 쿠팡 API 규제 준수:
# - 분당 12회만 호출 (제한 100회의 12%)
# - 각 호출 사이 5초 딜레이
# - 429/403 에러 시 즉시 중단

name: Collect Coupang Prices

on:
  # 매일 UTC 22:00 (KST 07:00) 실행
  schedule:
    - cron: '0 22 * * *'

  # 수동 실행 가능
  workflow_dispatch:

jobs:
  collect-prices:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # 최대 10분

    steps:
      - name: Collect Prices
        run: |
          echo "Starting price collection at $(date)"

          # API 호출
          response=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            "${{ secrets.APP_URL }}/api/cron/collect-prices")

          # 응답 파싱
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Status: $http_code"
          echo "Response: $body"

          # 상태 코드 확인
          if [ "$http_code" -ne 200 ]; then
            echo "Error: API returned status $http_code"
            exit 1
          fi

          # 성공 여부 확인
          success=$(echo "$body" | jq -r '.success')
          if [ "$success" != "true" ]; then
            echo "Warning: Collection completed with errors"
            echo "$body" | jq '.errors'
          fi

          echo "Price collection completed at $(date)"
          echo "$body" | jq '.totalProducts, .categories, .duration'

      - name: Report Status
        if: failure()
        run: |
          echo "Price collection failed!"
          # 여기에 슬랙/이메일 알림 추가 가능
