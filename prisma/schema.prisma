// 쿠팡 최저가 사이트 데이터베이스 스키마
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NextAuth.js Account 모델 (OAuth용)
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

// 사용자 모델
model User {
  id            String    @id @default(cuid())
  email         String?   @unique
  emailVerified DateTime?
  name          String?
  image         String?
  password      String?   // 이메일 로그인용 비밀번호
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // 관계
  accounts      Account[]
  sessions      Session[]
  favorites     Favorite[]
  alerts        Alert[]
}

// 세션 모델 (NextAuth)
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// VerificationToken (이메일 인증용)
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// 상품 모델
model Product {
  id              String   @id @default(cuid())
  coupangId       String   @unique  // 쿠팡 상품 ID
  name            String
  imageUrl        String
  productUrl      String   // 어필리에이트 링크
  categoryId      Int?
  categoryName    String?
  isRocket        Boolean  @default(false)
  isFreeShipping  Boolean  @default(false)

  currentPrice    Int      // 현재 가격
  lowestPrice     Int?     // 역대 최저가
  highestPrice    Int?     // 역대 최고가
  averagePrice    Int?     // 평균가

  lastViewedAt    DateTime? // 마지막 조회 시간 (사용자 상품 수집용)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // 관계
  priceHistory    PriceHistory[]
  favorites       Favorite[]
  alerts          Alert[]
}

// 가격 히스토리 모델
model PriceHistory {
  id        String   @id @default(cuid())
  productId String
  price     Int
  createdAt DateTime @default(now())

  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, createdAt])
}

// 관심상품 모델
model Favorite {
  id        String   @id @default(cuid())

  userId    String
  productId String

  // 쿠팡 상품 정보 (Product 없이도 저장 가능)
  coupangProductId  String
  productName       String
  productPrice      Int
  productImage      String
  productUrl        String
  categoryName      String?
  isRocket          Boolean @default(false)
  isFreeShipping    Boolean @default(false)

  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product? @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, coupangProductId])
  @@index([userId])
}

// 가격 알림 모델
model Alert {
  id           String   @id @default(cuid())

  userId       String
  productId    String?

  // 쿠팡 상품 정보
  coupangProductId  String
  productName       String
  productPrice      Int      // 알림 설정 시점 가격
  productImage      String
  productUrl        String

  targetPrice  Int      // 목표 가격
  isActive     Boolean  @default(true)
  triggeredAt  DateTime?
  createdAt    DateTime @default(now())

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product      Product? @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, coupangProductId])
  @@index([isActive])
  @@index([userId])
}

// 카테고리 캐시 모델
model CategoryCache {
  id           String   @id @default(cuid())
  categoryId   Int      @unique
  categoryName String
  data         String   // JSON 문자열로 저장
  updatedAt    DateTime @updatedAt
}

// 검색어 캐시 모델
model SearchCache {
  id        String   @id @default(cuid())
  keyword   String   @unique
  data      String   // JSON 문자열로 저장
  updatedAt DateTime @updatedAt
}

// 인기 검색어 모델
model SearchKeyword {
  id        String   @id @default(cuid())
  keyword   String   @unique
  count     Int      @default(1)
  updatedAt DateTime @updatedAt

  @@index([count])
}
